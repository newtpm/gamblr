--- 
title: "The *gamblr* Package"
subtitle: "Understanding Gambling Probabilities Through Simulations in R"
author: "Paul Newton"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
#css: style.css
documentclass: book
bibliography: [book.bib, packages.bib]
biblio-style: apalike
link-citations: yes
description: "Gambling Simulations"
---


# Preface {-}

> In gambling the many must lose in order that the few may win.
>
> --- **George Bernard Shaw**  *(Irish Playwright)*

I was watching TV one day when a Virginia Lottery advertisement for their new game Keno was shown. This got me to wondering how "fair" (or perhaps "rigged") the game was so I decided to find out by simulating a single Keno game, many times. The results were surprising and I decided I would expand it to beyond Keno. 

This book focuses purely on probabilities and expected payouts and does not attempt a social commentary on gambling. While gambling is not for me personally, if people enjoy the activity, then they are welcome to it as far as I am concerned. That said, perhaps after reading this book, when the true probabilities are better understood, some of the excitement may have evaporated. 

## A Work in Progress

Amongst the many wonderful things about online books is that they can be a perpetual work-in-progress. Consequently, I have published this book in an incomplete form, but one that contains stand-alone chapters that are (hopefully) an insightful read in and of themselves.

Any ideas or corrections can be submitted as a github issues <link> or sent to <address> 

# About the Author {-}

I am not a gambler, I chose to write this book solely as an intellectual curiosity. The genesis for the idea occurred a few years ago, while vacationing in Australia, where a restaurant had their own Keno game going (many Australian restaurants, bars and lifesaving clubs offer Electronic Gaming Machines or "pokies"). To keep my increasingly restless nine-year old occupied, we manually calculated the odds of winning in Keno - and I remember them as being absolutely awful. Fast forward a few years and I saw a TV advert for Keno by the Virginia Lottery - so one quiet weekend I decided to dive into the game and understand the payoffs a little better.

My day job, as founder of Barque Labs, is helping businesses improve their decision making capabilities and performance by providing a combination of analytics and domain expertise.

I recently moved to Geneva (Switzerland), after having spent 18 years in the Washington DC area. I work with (mostly) US-based clients and help them use their own readily-available data to optimize their business. I am a big fan of the R programming language (and what RStudio has contributed to it) because it lets me do things that I couldn't even envision when my analysis was largely Excel based.



<!--chapter:end:index.Rmd-->

# Gambling & Probabilities {#intro}

We all know that there is a 50% chance of a fair coin-flip coming up *Heads*. If you were offered a \$2 payout for correctly guessing Heads or Tails on a \$1 bet, you could intuitively deduce that a single bet would result in the binary outcome of you having either gained or lost \$1. Further, you could mentally extrapolate to see that the more often this bet is made, the more likely you are to end up at breakeven. Nothing to clever here, if we didn't encounter this is a statistics class, we certainly learned it over years of experience. 

Now, what if for that \$1 bet the payout was \$5 for getting it correct? It's easy to mentally determine that we would want to play this game as often as possible. But what if the payout was only \$1.90? This is certainly a lot less attractive a bet and most people would elect not to play. However, this [house edge](https://knowyourodds.net.au/house-edge/#:~:text=The%20House%20Edge%20is%20a,loss%20of%20what%20you%20bet) of 10% is on the low end of what most games offer.  

What makes the game more appealing would be the possibility of a large payout. Let's change the payout to be \$1.90 for a correct result, but if you are correct 10 times in a row, there is a further $750 payout. Now it is not so clear whether this bet should be accepted, and requires some probability calculations to determine whether it is a good or bad bet. Nevertheless, \$750 sounds like a large amount and it is this possibility of a large payout that encourages people to accept the bet. Whether this improved incentive makes it a worthy bet will be shown later.


### Fair Bets & Expected Values

A *fair bet* is one where your net expected value is the same as your cost. So if I were to bet \$1 that a fair coin flip would be heads and it pays out \$2, this would be a *fair bet* because my *expected value* (i.e. payout * probability or [\$2 * 0.5] ) equals my wager of \$1.  You usually make *fair bets* with friends and family and the wagers are fully distributed to the players. 

One couldn't expect formal gambling games to be *fair* as the establishments need to be profitable, but how do you determine the level to which the game is biased against you? We use *expected value* (EV) as a means to determine this.

```{r nice-fig, fig.cap='Here is a nice figure!', out.width='80%', fig.asp=.75, fig.align='center'}
par(mar = c(4, 4, .1, .1))
plot(pressure, type = 'b', pch = 19)
```

Reference a figure by its code chunk label with the `fig:` prefix, e.g., see Figure \@ref(fig:nice-fig). Similarly, you can reference tables generated from `knitr::kable()`, e.g., see Table \@ref(tab:nice-tab).

```{r nice-tab, tidy=FALSE}
knitr::kable(
  head(iris, 20), caption = 'Here is a nice table!',
  booktabs = TRUE
)
```

You can write citations, too. For example, we are using the **bookdown** package [@R-bookdown] in this sample book, which was built on top of R Markdown and **knitr** [@xie2015].

<!--chapter:end:02-probs.Rmd-->

# Slightly Technical Backdrop {-}

# Monte Carlo Simulations

From [Investopedia](https://www.investopedia.com/terms/m/montecarlosimulation.asp) *"Monte Carlo (MC) simulations are used to model the probability of different outcomes in a process that cannot easily be predicted due to the intervention of random variables."*

Many event outcomes follow a deterministic pattern. Go back to our coin-flipping and we can determine that flipping a fair coin 1,000 times would give us *approximately* 500 Heads. It is commonly known that the probability of heads (0.5) multiplied by the number of flips (1000) provides the expected number of Heads - plus a random variation so the number is unlikely to be exactly 500 Heads so figuring this out is not difficult. 

Nevertheless, we could also build a model for coin flipping and count the number of Heads after 1,000 flips. Then run it thousands of times to get an approximation of the expected count of Heads. While not particularly valuable in this case, imagine we wanted to know the probability of getting more than 500 Heads if 70 of the first 100 flips were Heads. Again, this could be derived from adapting our equation above, but the simulation method starts to become more useful as we could simply filter our simulations where there are 70 Heads in the first 100 flips then find the proportion of times that we end up with more than 500 Heads.

**Note:** A coin-flip is memory-less, meaning the first 100 flips have no bearing on the remaining 900 flips. Consequently, a more efficient simulation would be to run each game with 900 flips, and count the times that more than 430 Heads (500 - 70) appear.

As the game we are playing gets progressively more complicated, direct calculation of probabilities via statistical formulas becomes increasingly difficult to everyone but highly-trained statisticians. So we rely on the results that a simulation provides - with the caveat that these are approximations that become increasingly reliable as the number of run simulations increases.  


## Building MC Simulations

We only need to scratch the surface on Monte Carlo simulations in this book, but a broader introduction can be found on [Wikipedia](https://en.wikipedia.org/wiki/Monte_Carlo_method). In the *Overview* section, there are four common stages to an MC simulation:

1. **Define a Domain of Possible Inputs:** The parameters of the game like possible numbers and payout calculations 
2. **Generate Inputs Randomly from a Probability Distribution over the Domain:** Random game outcomes when played.
3. **Perform a Deterministic Computation on the Inputs:** Calculate the payouts and other game results for a single game.
4. **Aggregate the Results:** Aggregate across the hundreds of thousands (or millions) of simulations run.


In order to rI use the statistical programming language [R](https://www.r-project.org/) to simulate enough games of Keno, that we get a reasonably accurate insight of the probability of various outcomes. A knowledge or R is not necessary to understand this article, although the code is readable enough that anyone will be able to get the gist. For those who are interested in the related R code, press *Show All Code* in the top right of this document.

## Our R Envronment

```{r eval=FALSE}
library(tidyverse)
library(readxl)

sims = 1e3
```
1e5 sims are enough to reduce any random effect to a minimal level and we should feel confident in the **approximate** probabilities we derive. Our total simulation summary is shown below... The trade-off with accuracy is the time it takes to run the simulations. 


We describe our methods in this chapter.

<!--chapter:end:03-technical.Rmd-->

# Keno

Our Keno simulation is modeled on the game provided by the Virginia State Lottery. [Keno](https://www.valottery.com/data/draw-games/keno). 

## The Game

In the Virginia version of the game, players pick from 1 to 10 numbers or "spots" (from the population range of 1 to 80). The Lottery then randomly picks 20 numbers from the same 1 to 80 range and players win predetermined amounts based on the number of matches they have. Virginia Lottery have a good explanation in a [2-minute marketing video](https://www.youtube.com/watch?v=LNPsMmxjQDc). 

### Simulating a Game in R

Assuming the game is unbiased, we can simulate a single game quite easily. Let's play the 10-Spot game, one-time, waging \$1. Below we pick 10 numbers (spots = 10) from the population range in `pick` and then simulate a single game's drawing of 20 numbers in `draw`. 

```{r, message=F, warning=F}

spots <- 10 # the number of spots in our simulated game
keno_range <- 1:80
set.seed(11) # so that random outcomes can be reproduced

pick <- sample(keno_range, spots)
sort(pick) # sorted for viewing convenience

draw <- sample(keno_range, 20)
sort(draw)
```

Apparently, we have five matches in this particular game which sounds pretty promising as half of our 10 spots were selected. Below we fetch them from the two objects `pick` and `draw` that we created above.

```{r}
sort(draw[draw %in% pick]) # subset from draw when the number is found in pick
```

Now we need to look-up the associated Prize for our five matches from a 10-Spot game as per the published table in the Odds table of Virginia Lottery's [Keno page](https://www.valottery.com/data/draw-games/keno).
  
![](./www/keno odds pic.PNG)

Which turns out to be a Prize of \$3, or \$2 net of our ticket cost. We have won 2x our wager which is a nice return. 

Do note however, that the odds of such an outcome in the table above is 19 (read as 1 in 19) or a 5.26% probability. At first glance, this may seem a  disproportionately small payoff for the odds of getting 5 spots correct, and that would be correct if the player had to specify the match level they were playing. But because there is a payoff (in the 10-Spot game) for all matches except 1, 2 or 3 matches there is a higher probability of getting a match at some level so the payoff to odds ratio is better. And below we'll show how much better. 


## The `play_keno` Function

Now that the basics of the game are understood, let's wrap that single game into a function for reuse in our simulation. Note that the manual prize lookup has been automated via a manually created `prize_table`. The output of the function is a small table with a single row and the games parameters. 

```{r}

play_keno <- function(spots, keno_range = 1:80, draw_size = 20, wager = 1) {
  
  pick <- sample(keno_range, spots) # same as above
  draw <- sample(keno_range, draw_size) # same as above

  
  matches <- sum(pick %in% draw) # we don't care whichs number match, just the total
  
  prize <- prize_table %>%
    select(Match, contains(as.character(spots))) %>% # isolate column for the game we are playing
    filter(Match == matches) %>% #isolate the matches we made
    pull(2) # isolate just the numeric from the dataframe
  
  tmp <- tibble(Spots = spots,
                Wager = wager,
                Matches = matches,
                Prize = prize * wager ) %>%
    mutate(Net = Prize - Wager,
           Result = factor(ifelse(Prize == 0, "Lose", "Win"))) # color mapping for our charts
  
  return(tmp)
}

prize_table <- read_xlsx("./input/keno prizes.xlsx") # load our prize table
set.seed(11) # to creat the same random outputs as above
gt(play_keno(10)) # play a 10-Spot game, show in nice table with gt()

```

Interpreting the table above, we played the 10 spot game for a wager of $1 and got 5 matches equating to a \$3 prize (\$2 net of wager).

The official Virginia game allows for wagers of \$1 to \$10 which multiplies the prize by the wagered amount. So if we had made a \$5 wager above, our prize would have been \$15 (\$3 * 5). For simplicity and consistency, we are only going to consider wagers of $1 in our simulations as the probabilities hold, given the linear relationship of the prize to the wager.   

## Play 100,000 Games of Keno

In [Our R Environment] we set the number of simulations (`sims`) to 100,000. 

Next we set our number of simulations to 100,00 and `play_keno()` for each sim. 100K sims 

```{r}

plays <- 1:sims %>% # play a game for each sim
  map_dfr(function(x) play_keno(spots)) %>% # play a 10-Spot game with our function play_keno()
  mutate(Sim = 1:sims, # sim ID's
         Cumulative = cumsum(Net)) %>% # calc cumulative sum
  relocate(Sim) # move Sim to the first column

gt(plays %>%
  summarise(Sims = n(),
            Wager = sum(Wager),
            Prize = sum(Prize),
            Net = sum(Net), .groups = "drop") %>%
    mutate(Prob = round(Sims / sims, 3),
            EV = Prize / Sims * Prob) ) %>%
    tab_header(
    title = "Summary Results of 100K Simulated Games",
    subtitle = "Subtitle"
  ) 
  

```

For `r round(nrow(plays)/1e3, 0)`K simulations, we wagered \$`r round(sum(plays$Wager)/ 1e3, 0)`K and lost \$`r round(-sum(plays$Net)/ 1e3, 2)`K of it. Put another way, our expected value (EV) for the 10-Spot game is \$`r round( sum(plays$Prize) / sum(plays$Wager), 2)`



```{r}
summary <- plays %>%
  group_by(Matches) %>%
  summarise(Sims = n(),
            Wager = sum(Wager),
            Prize = sum(Prize),
            Net = sum(Net), .groups = "drop") %>%
  mutate(Prob = round(Sims / sims, 3),
         EV = Prize / Sims * Prob,
         Odds = round(1/EV, 0))

summary # results of our sims
```

Despite the best match level's expected value being only `r round(max(summary$EV) * 100, 1)` (above), our expected value for each game is `r round(sum(plays$EV) * 100, 0)` cents. This dynamic is due to the fact that players do not need to specify a match level beforehand. Thus, they participate in the payout at any winning level and their combined EV is the sum of all EV's. 

*Note:* The simulated probability of getting 5 matches in the 10-Spot game is 5.2% - which is consistent with the stated odds (1/19) for five matches. This illustrates an value attribute of simulations - despite not knowing the formula that the Lottery used for their odds, we have been able to validate them as being acceptably accurate.


## Net Position After 30 Games

With an EV of  `r round(sum(plays$EV), 2)` cents. we would expect to have \$`r round(sum(plays$EV) * 30 , 2)` in our pocket after wagering \$30 across 30 games. But no one plays Keno for the expected value, it is the big prizes that attracts players. So let's play 30 games, 1,000 times, and see what our ending balances are after this defined gameset.

```{r}

games <- 30
sims2 <- 1000

plays2 <- tibble()

for (i in 1:sims2) {
  
  games_batch <- 1:30 %>% # for each sim
    map_dfr(function(x) play_keno(spots)) %>%
    summarise(Net = sum(Net)) %>%
    mutate(Sim = i) %>% # calc cumulative sum
    relocate(Sim)
    
   plays2 <- plays2 %>%
     bind_rows(games_batch) %>%
     mutate(Color = factor(case_when(
       Net <= 0 ~ "-$30 - $0 Loss",
       Net > 0 & Net <= 30 ~ "$1-$30 Gain",
       Net > 30 & Net <= 60 ~ "$31-$60 Gain",
       Net > 60 & Net <= 90 ~ "$61-$90 Gain",
       TRUE ~ ">$90 Gain" )))
  
}

ggplot(plays2, aes(Sim, Net, color = Color)) +
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = mean(plays2$Net))

summ_plays2 <- plays2 %>%
  group_by(Color) %>%
  summarise(Count = n(),
            Mean = mean(Net))


ggplot(plays2, aes(Net)) +
  geom_histogram(binwidth = 30) 

```

## Strategy Testing

Some possible strategies and their effectiveness against the baseline above (??)

## Conclusion

### Reconciling to Original (Manual in a Restaurant) Analysis

I realize now that my original calculation did not appreciate the sum of the EV's as being relevant (because players participate at all match levels in each game, rather then pre-specifying a match level). So my original EV was considerably understated. 

From this, we can draw some important lessons.

1. Don't do probability after a couple of beers at lunch.
2. Even when system probabilities are thought to be understood, a simulation will either prove it out or provide a better understanding. 

This has been a fun excercise, I hope you enjoyed it and learned a little bit about deriving probabilities when direct mathematical calculation is impractical.

<!--chapter:end:04-keno.Rmd-->

# Powerball

> If you enjoy playing for big cash prizes, then Powerball is the game for you! Powerball could make you the next multimillionaire
>
> **Virginia Lottery**

Well, with that sort of tag-line *Powerball* sounds simply wonderful. Here we dive into the game and look into how likely you are to become the next millionaire.

### Multiple Winners {-}

> If more than one ticket matches all six numbers in a drawing, winners will share the jackpot.

Likelihood of multiple winners...bigger the prize > more players > higher chance of split > lower payout

### Cash vs Annual Payout {-}

> If you do win the jackpot, you will need to choose either an annual payout or cash option when you claim your prize. 

There is a DCF consideration here.


<!--chapter:end:05-powerball.Rmd-->

`r if (knitr::is_html_output()) '
# References {-}
'`

<!--chapter:end:06-references.Rmd-->

# Final Words

We have finished a nice book.

<!--chapter:end:09-summary.Rmd-->

